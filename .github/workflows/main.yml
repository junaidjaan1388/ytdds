name: YouTube Downloader - Fixed Paths

on:
  workflow_dispatch:
    inputs:
      youtube_url:
        description: 'YouTube URL to download'
        required: true
        type: string
      format:
        description: 'Download format'
        required: false
        type: choice
        default: 'mp4'
        options:
          - mp4
          - mp3
          - best

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y ffmpeg
        python -m pip install --upgrade pip
        pip install yt-dlp
        
    - name: Create working directory
      run: |
        pwd
        ls -la
        mkdir -p youtube_downloads
        echo "Working directory created"
        
    - name: Create cookies file
      env:
        YOUTUBE_COOKIES: ${{ secrets.YOUTUBE_COOKIES }}
      run: |
        if [ -n "$YOUTUBE_COOKIES" ]; then
          echo "$YOUTUBE_COOKIES" > youtube_downloads/cookies.txt
          echo "‚úÖ Cookies file created"
        else
          echo "‚ö†Ô∏è No cookies provided"
        fi
        
    - name: Download YouTube content
      env:
        URL: ${{ github.event.inputs.youtube_url }}
        FORMAT: ${{ github.event.inputs.format }}
      run: |
        cd youtube_downloads
        
        # Set format arguments
        if [ "$FORMAT" == "mp3" ]; then
          FORMAT_ARGS="-x --audio-format mp3 --audio-quality 0"
          echo "Downloading as MP3"
        elif [ "$FORMAT" == "mp4" ]; then
          FORMAT_ARGS="-f best[height<=720]"
          echo "Downloading as MP4 (720p max)"
        else
          FORMAT_ARGS="-f best"
          echo "Downloading best quality available"
        fi
        
        # Use cookies if available
        if [ -f "cookies.txt" ]; then
          COOKIES_ARG="--cookies cookies.txt"
          echo "Using cookies for authentication"
        else
          COOKIES_ARG=""
          echo "No cookies available"
        fi
        
        # Download command
        yt-dlp $COOKIES_ARG \
          --ignore-errors \
          --no-warnings \
          --retries 3 \
          --fragment-retries 3 \
          $FORMAT_ARGS \
          -o "%(title).100B.%(ext)s" \
          "$URL"
        
        echo "Download process completed"
        
    - name: List downloaded files
      run: |
        echo "üìÅ Current directory:"
        pwd
        echo "üìÅ Contents of youtube_downloads:"
        ls -la youtube_downloads/ || echo "No youtube_downloads folder"
        echo "üìÅ Files in youtube_downloads:"
        find youtube_downloads -type f -name "*" 2>/dev/null || echo "No files found"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: youtube-downloads
        path: youtube_downloads/
        retention-days: 1
      if: always()
